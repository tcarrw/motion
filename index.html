<!DOCTYPE html>
<html lang="en" data-theme="emerald-drift">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Motion ‚Äî Flow Studio (Miss Monique)</title>
<meta name="description" content="Flow Studio for Miss Monique sets ‚Äî cut segments, chain sequences, save favorites with DJ notes, share exact states, and log Check‚ÄëIns. Green Edition." />
<style>
  :root{
    --radius: 14px;
    --pad: 12px;
    --gap: 12px;
    --fg: #e9fffa;
    --fg-dim:#c7efe4;
    --bg:#071a16;
    --bg-panel: color-mix(in sRGB, var(--accent) 8%, #0a0f0e 78%);
    --glass-border: color-mix(in sRGB, var(--accent) 55%, rgba(255,255,255,0));
    --shadow: 0 8px 26px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
    --focus: color-mix(in sRGB, var(--accent) 70%, white 15%);
    --muted: #a8e5d4;
    --chip: #0d2d27;
    --chip-border: color-mix(in sRGB, var(--accent) 55%, transparent);
    --ok:#32ffbe; /* Neon Sprout for accents on success */
    --warn:#ffd166;
    --danger:#ff6b6b;
    --accent:#0bbf8a; /* Emerald Drift default */
  }

  /* THEME TOKENS (named greens) */
  html[data-theme="emerald-drift"]{ --accent:#0bbf8a; }
  html[data-theme="teal-current"]{ --accent:#00c2a8; }
  html[data-theme="jade-pulse"]{ --accent:#15a87a; }
  html[data-theme="forest-glass"]{ --accent:#0a6a4e; }
  html[data-theme="verdigris-line"]{ --accent:#19e6cb; }
  html[data-theme="celadon-mist"]{ --accent:#a8e5d4; }
  html[data-theme="pine-shadow"]{ --accent:#093c31; }
  html[data-theme="mint-vapor"]{ --accent:#d6fff3; }
  html[data-theme="seafoam-glow"]{ --accent:#6dd9c5; }
  html[data-theme="neon-sprout"]{ --accent:#32ffbe; }

  @media (prefers-color-scheme: light){
    :root{ --fg:#051510; --fg-dim:#12352c; --bg:#f0fffb; --bg-panel: color-mix(in sRGB, var(--accent) 8%, #ffffff 88%); --shadow: 0 8px 26px rgba(0,0,0,.09), inset 0 1px 0 rgba(0,0,0,.06); --chip:#eafff7; }
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:500 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
    color:var(--fg); background: radial-gradient(1200px 1200px at 15% -10%, color-mix(in sRGB,var(--accent) 22%, #000 0%), transparent 60%), linear-gradient(180deg, #050b0a, var(--bg));
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{ max-width:1100px; margin:0 auto; padding:16px; display:grid; grid-template-columns: 1fr; gap:var(--gap); }
  header.hero{
    border:1px solid var(--glass-border);
    background:var(--bg-panel);
    box-shadow:var(--shadow);
    border-radius:calc(var(--radius) + 6px);
    padding:18px clamp(14px, 3vw, 24px);
    position:sticky; top:0; z-index:5;
    backdrop-filter: saturate(1.2) blur(10px);
  }
  .h1{font-weight:800;letter-spacing:.2px; font-size:clamp(22px, 3.3vw, 30px); margin:0 0 3px}
  .sub{opacity:.9}
  .why, .ritual{ color: var(--fg-dim); font-size:.95rem; margin-top:6px }
  .panel{
    border:1px solid var(--glass-border);
    background:var(--bg-panel);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding: clamp(12px, 2.6vw, 18px);
  }
  .panel h2{ font-size:1.05rem; margin:.2rem 0 .6rem; letter-spacing:.2px }
  .panel h3{ font-size:1rem; margin:.6rem 0 .3rem; }
  .row{ display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap }
  .grow{ flex:1 1 auto }
  .actions{ display:flex; gap:8px; flex-wrap:wrap }
  button, .btn, input[type="text"], input[type="number"], input[type="time"], textarea, select{
    appearance:none; border-radius:10px; border:1px solid color-mix(in sRGB, var(--accent) 55%, transparent);
    background: color-mix(in sRGB, var(--accent) 10%, #07110f 70%); color:var(--fg);
    padding:10px 12px; font-weight:600; transition: transform .16s ease, background .16s ease, border-color .16s ease, box-shadow .16s ease;
    outline: none;
  }
  button:hover, .btn:hover{ transform: translateY(-1px); }
  button:active{ transform: translateY(0) scale(.99); }
  button.primary{
    background: linear-gradient(180deg, color-mix(in sRGB, var(--accent) 70%, #fff 5%), color-mix(in sRGB, var(--accent) 45%, #000 12%));
    color: #03241c; border-color: color-mix(in sRGB, var(--accent) 70%, #fff 10%);
  }
  button.ghost{ background: color-mix(in sRGB, var(--accent) 5%, transparent); }
  .chip{
    display:inline-flex; align-items:center; gap:6px; padding:5px 9px; border-radius:999px;
    border:1px solid var(--chip-border); background:var(--chip); font-size:.86rem;
  }

  /* Focus visibility */
  :where(button, .btn, input, textarea, select, [tabindex]) :focus,
  :where(button, .btn, input, textarea, select, [tabindex]):focus{
    outline: 2px solid var(--focus); outline-offset:2px;
  }

  /* Player */
  .player-wrap{ position:relative; width:100%; aspect-ratio:16/9; border-radius:12px; overflow:hidden; background: #000; border:1px solid var(--glass-border) }
  .player-wrap iframe{ width:100%; height:100%; border:0; display:block }
  .overlay-start{
    position:absolute; inset:0; display:grid; place-items:center; background:linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.3));
    opacity:1; transition: opacity .18s ease; z-index:2;
  }
  .overlay-start.hidden{ opacity:0; pointer-events:none }
  .overlay-start .big{
    font-size: clamp(15px, 2.6vw, 18px); letter-spacing:.3px;
    padding:14px 16px; border-radius:999px; border:1px solid var(--glass-border); background:color-mix(in sRGB, var(--accent) 12%, #00130f 60%);
  }

  /* Controls */
  .controls{ margin-top:10px; display:grid; grid-template-columns: 1fr; gap:10px }
  .controls .bar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
  .timer{ font-feature-settings:"tnum"; font-variant-numeric:tabular-nums; padding:10px 12px; border-radius:10px; border:1px solid var(--glass-border); background:color-mix(in sRGB, var(--accent) 8%, #07110f 70%); min-width:84px; text-align:center }
  .vol{ display:flex; align-items:center; gap:8px }
  input[type="range"]{ width:160px; accent-color:var(--accent) }
  .mode-tabs{ display:flex; gap:6px; }
  .mode-tabs button{ padding:8px 10px; border-radius:10px }
  .mode-tabs button[aria-pressed="true"]{ background:color-mix(in sRGB, var(--accent) 25%, #00130f 40%); border-color: color-mix(in sRGB, var(--accent) 70%, transparent) }

  /* Studio layout */
  .grid-2{ display:grid; grid-template-columns: 1fr; gap:var(--gap) }
  @media (min-width: 800px){ .grid-2{ grid-template-columns: 1.06fr .94fr } }

  .fields{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:8px }
  .fields .wide{ grid-column: 1 / -1 }
  .fields .half{ grid-column: span 2 }
  .fields label{ font-size:.8rem; opacity:.9; display:block; margin-bottom:4px }
  textarea{ min-height:80px; resize:vertical }

  /* Favorites grid */
  .favorites{ display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:var(--gap) }
  .fav{ border:1px solid var(--glass-border); background: color-mix(in sRGB, var(--accent) 7%, #091412 72%); border-radius:12px; padding:10px; display:grid; gap:8px }
  .swatch{ width:18px; height:18px; border-radius:5px; border:1px solid color-mix(in sRGB, var(--accent) 70%, transparent) }

  /* Display mode */
  body[data-view="display"] .studio,
  body[data-view="display"] .favorites-panel,
  body[data-view="display"] .share-panel,
  body[data-view="display"] .checkin-panel,
  body[data-view="display"] .help-panel{ display:none !important }
  .display-header{ display:none; }
  body[data-view="display"] .display-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px }
  .display-header .person{ display:flex; align-items:center; gap:12px }
  .avatar{ width:40px; height:40px; border-radius:50%; border:1px solid var(--glass-border); background:#0d221d center/cover no-repeat }
  .badge{ padding:6px 8px; border-radius:999px; border:1px solid var(--glass-border); background:color-mix(in sRGB, var(--accent) 10%, #07110f 70%); cursor:pointer }
  body[data-view="display"] .controls .bar:first-child button.primary{ font-size:1.05rem; padding:12px 16px }
  body[data-locked="true"] .editable{ pointer-events:none; opacity:.6; filter:grayscale(.1) }

  /* Check-in cards */
  .cards{ display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:var(--gap) }
  .card{ border:1px solid var(--glass-border); background: color-mix(in sRGB, var(--accent) 7%, #091412 72%); border-radius:12px; padding:10px }

  /* Help list */
  .kbd{ font-weight:800; padding:2px 7px; border:1px solid var(--glass-border); border-radius:7px; background:color-mix(in sRGB, var(--accent) 12%, transparent); }

  /* Links and subtle fades */
  a{ color: var(--muted); text-decoration: none; border-bottom:1px dotted color-mix(in sRGB, var(--accent) 40%, #fff 0%); }
  @media (prefers-reduced-motion:no-preference){
    .fade{ animation:fade .18s ease both }
    @keyframes fade{ from{opacity:0; transform:translateY(2px)} to{opacity:1; transform:none} }
  }

  /* Accessibility utility */
  .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
</style>
</head>
<body>
  <div class="wrap">
    <header class="hero" role="banner" aria-label="Motion Flow Studio header">
      <div class="row" style="justify-content:space-between; align-items:flex-start">
        <div>
          <div class="h1">Motion ‚Äî Flow Studio (Miss Monique)</div>
          <div class="sub"> <em>Pulse that steadies the mind. Movement before meaning.</em></div>
          <div class="why"> <strong>Why:</strong> <em>Dance first, think later. Warm body, clear head. Then choose your next page.</em></div>
          <div class="ritual"> <strong>Ritual:</strong> <em>Breath ‚Üí Step ‚Üí Release</em> (4-2-6 breathing; jaw unclench @6m; soft eyes at close)</div>
        </div>
        <div class="actions" aria-label="Theme and view">
          <button id="displayToggle" class="btn ghost" aria-pressed="false" aria-label="Toggle Display Mode">Display</button>
          <select id="themePicker" aria-label="Theme picker (named greens)">
            <option value="emerald-drift">Emerald Drift</option>
            <option value="teal-current">Teal Current</option>
            <option value="jade-pulse">Jade Pulse</option>
            <option value="forest-glass">Forest Glass</option>
            <option value="verdigris-line">Verdigris Line</option>
            <option value="celadon-mist">Celadon Mist</option>
            <option value="pine-shadow">Pine Shadow</option>
            <option value="mint-vapor">Mint Vapor</option>
            <option value="seafoam-glow">Seafoam Glow</option>
            <option value="neon-sprout">Neon Sprout</option>
          </select>
        </div>
      </div>
    </header>

    <!-- Flow Room -->
    <section class="panel flow-room" aria-label="Flow Room">
      <div class="display-header">
        <div class="person">
          <div class="avatar" id="displayAvatar" aria-hidden="true"></div>
          <div>
            <div id="displayName" style="font-weight:800">Guest</div>
            <div class="chip" id="displayBadge" title="Long-press to unlock editor (PIN)">
              <span aria-hidden="true">üîí</span> <span>Locked</span>
            </div>
          </div>
        </div>
        <div class="actions">
          <button id="lockBtn" class="btn ghost" aria-label="Lock Display quickly">Lock Display</button>
        </div>
      </div>

      <div class="player-wrap" aria-label="Video player area">
        <div id="startOverlay" class="overlay-start" role="dialog" aria-modal="false" aria-live="polite">
          <button id="startBtn" class="big primary" aria-label="Start playback">Start</button>
        </div>
        <iframe id="yt" title="Miss Monique ‚Äî official set"
          loading="lazy"
          allow="autoplay; encrypted-media; picture-in-picture; fullscreen"
          src=""
          referrerpolicy="strict-origin-when-cross-origin">
        </iframe>
      </div>

      <div class="controls editable" role="region" aria-label="Playback controls">
        <div class="bar">
          <button id="playPause" class="primary" aria-label="Start or Pause">Start</button>
          <div class="timer" id="timerText" aria-live="polite" aria-atomic="true" title="Time remaining">12:00</div>
          <button id="extend" class="btn" aria-label="Extend by 5 minutes">+5m Extend</button>
          <div class="actions">
            <button class="btn ghost preset" data-preset="quick" aria-label="Quick 12 minutes">Quick 12m</button>
            <button class="btn ghost preset" data-preset="deep" aria-label="Deep 20 minutes">Deep 20m</button>
            <button class="btn ghost preset" data-preset="night" aria-label="Night 12 minutes">Night 12m</button>
          </div>
          <div class="vol">
            <label for="vol" class="sr-only">Volume</label>
            <span>üîä</span>
            <input id="vol" type="range" min="0" max="1" step="0.01" value="0.8" aria-valuemin="0" aria-valuemax="1" aria-label="Volume slider"/>
          </div>
        </div>

        <div class="bar">
          <div class="mode-tabs" role="tablist" aria-label="Play mode">
            <button id="modeWhole"   role="tab" aria-selected="true"  aria-pressed="true"  class="btn ghost">Whole</button>
            <button id="modeWindow"  role="tab" aria-selected="false" aria-pressed="false" class="btn ghost">Segment</button>
            <button id="modeSeq"     role="tab" aria-selected="false" aria-pressed="false" class="btn ghost">Sequence</button>
          </div>
          <div class="actions">
            <button id="prevCut" class="btn ghost" aria-label="Previous cut (Q)">‚óÄ Prev</button>
            <button id="nextCut" class="btn ghost" aria-label="Next cut (E)">Next ‚ñ∂</button>
            <span id="cutLabel" class="chip" aria-live="polite" title="Current cut label" style="display:none"></span>
          </div>
          <div class="grow"></div>
          <div class="actions">
            <select id="trackPicker" aria-label="Select track"></select>
          </div>
        </div>
      </div>
    </section>

    <!-- Studio + Advanced Playback -->
    <section class="panel studio editable" aria-label="Flow Studio (Editor)">
      <div class="grid-2">
        <!-- Segment editor -->
        <div>
          <h2>Segment Editor</h2>
          <div class="fields">
            <div class="half">
              <label for="segStart">Start (mm:ss or sec)</label>
              <input id="segStart" type="text" inputmode="numeric" placeholder="0:00" />
            </div>
            <div class="half">
              <label for="segEnd">End (mm:ss or sec)</label>
              <input id="segEnd" type="text" inputmode="numeric" placeholder="12:00" />
            </div>
            <div class="half" style="display:flex;align-items:end;gap:8px">
              <input id="segLoop" type="checkbox" aria-label="Loop segment" /> <label for="segLoop">Loop</label>
            </div>
            <div class="half" style="display:flex;align-items:end;gap:8px">
              <button id="applySeg" class="btn">Apply</button>
            </div>
            <div class="half">
              <button id="fromNow12" class="btn ghost" aria-label="From now plus 12 minutes">From now +12m</button>
            </div>
            <div class="half">
              <button id="fromNow20" class="btn ghost" aria-label="From now plus 20 minutes">From now +20m</button>
            </div>
            <div class="wide"><hr style="border:none;border-top:1px solid var(--glass-border)" /></div>
            <div class="wide">
              <h3>Tap-Tempo</h3>
              <div class="row">
                <button id="tapBtn" class="btn" aria-label="Tap to estimate BPM">Tap</button>
                <div class="chip">BPM: <span id="bpmOut">‚Äî</span></div>
                <label class="sr-only" for="barsSel">Bars</label>
                <select id="barsSel" aria-label="Choose bars">
                  <option value="8">8 bars</option>
                  <option value="16" selected>16 bars</option>
                  <option value="32">32 bars</option>
                </select>
                <button id="snapWindow" class="btn ghost" aria-label="Create bar-aligned segment">Snap window</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Sequence editor -->
        <div>
          <h2>Sequence Editor</h2>
          <div class="fields">
            <div>
              <label for="cutStart">Start</label>
              <input id="cutStart" type="text" placeholder="e.g., 1:20" />
            </div>
            <div>
              <label for="cutEnd">End</label>
              <input id="cutEnd" type="text" placeholder="e.g., 2:40" />
            </div>
            <div>
              <label for="cutRepeats">Repeats</label>
              <input id="cutRepeats" type="number" min="0" step="1" value="0" />
            </div>
            <div style="display:flex;gap:8px;align-items:end">
              <input id="cutLoop" type="checkbox" /> <label for="cutLoop">Loop ‚àû</label>
            </div>
            <div class="wide">
              <label for="cutLabel">Label</label>
              <input id="cutLabelInput" type="text" placeholder="Jam loop / Build / etc." />
            </div>
            <div class="wide">
              <button id="addCut" class="btn">Add cut</button>
            </div>
          </div>

          <div id="cutsList" class="fade" role="list" aria-label="Current cuts" style="margin-top:8px; display:grid; gap:8px"></div>

          <div class="row" style="margin-top:8px">
            <label class="chip" style="gap:8px">Loop sequence
              <input id="loopSeq" type="checkbox" aria-label="Loop entire sequence" style="margin-left:8px" />
            </label>
            <button id="applySeq" class="btn">Apply sequence</button>
            <div class="grow"></div>
            <button id="btnPrevCut" class="btn ghost" aria-label="Previous cut">Prev</button>
            <button id="btnNextCut" class="btn ghost" aria-label="Next cut">Next</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Share & Favorites -->
    <section class="panel share-panel editable" aria-label="Share & Export">
      <h2>Share Tools</h2>
      <div class="row">
        <button id="copyLink" class="btn">Copy share link</button>
        <button id="exportState" class="btn ghost">Export .json</button>
        <div id="shareMsg" class="chip" aria-live="polite" style="display:none"></div>
      </div>
    </section>

    <section class="panel favorites-panel editable" aria-label="Favorites with DJ Notes">
      <div class="row" style="justify-content:space-between; align-items:flex-end">
        <h2>Favorites <span class="chip">‚≠ê Save + DJ Notes</span></h2>
        <div class="row">
          <select id="favColor" aria-label="Favorite color tag">
            <option value="emerald-drift">Emerald Drift</option>
            <option value="teal-current">Teal Current</option>
            <option value="jade-pulse">Jade Pulse</option>
            <option value="forest-glass">Forest Glass</option>
            <option value="verdigris-line">Verdigris Line</option>
            <option value="celadon-mist">Celadon Mist</option>
            <option value="pine-shadow">Pine Shadow</option>
            <option value="mint-vapor">Mint Vapor</option>
            <option value="seafoam-glow">Seafoam Glow</option>
            <option value="neon-sprout">Neon Sprout</option>
          </select>
          <input id="favTitle" type="text" placeholder="Title (optional)" aria-label="Favorite title" />
          <input id="favNotes" type="text" placeholder="DJ Notes (optional)" aria-label="DJ Notes" />
          <button id="saveFav" class="btn">‚≠ê Save Favorite</button>
        </div>
      </div>
      <div id="favorites" class="favorites" style="margin-top:10px"></div>
    </section>

    <!-- Check-In -->
    <section class="panel checkin-panel editable" aria-label="Check-In">
      <h2>Check-In (MirrorHoney-style)</h2>
      <div class="fields">
        <div>
          <label for="ciMood">Mood</label>
          <input id="ciMood" type="text" placeholder="One word" />
        </div>
        <div>
          <label for="ciEnergy">Energy (0‚Äì10)</label>
          <input id="ciEnergy" type="range" min="0" max="10" step="1" value="5" />
        </div>
        <div>
          <label for="ciBody">Body</label>
          <select id="ciBody">
            <option>Loose</option>
            <option selected>Neutral</option>
            <option>Tight</option>
          </select>
        </div>
        <div class="wide">
          <label for="ciIntent">Intention</label>
          <input id="ciIntent" type="text" placeholder="One-liner intention" />
        </div>
        <div class="wide">
          <label for="ciNotes">Notes</label>
          <textarea id="ciNotes" placeholder="Session reflections"></textarea>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="ciLog" class="btn">Log</button>
        <button id="ciExport" class="btn ghost">Export .json</button>
        <button id="ciClear" class="btn ghost">Clear log</button>
      </div>
      <div id="ciCards" class="cards" style="margin-top:10px"></div>
    </section>

    <!-- Help -->
    <section class="panel help-panel" aria-label="Keyboard shortcuts">
      <h2>Shortcuts</h2>
      <div class="row" style="flex-wrap:wrap; gap:10px">
        <span class="kbd">Space</span> Start/Pause
        <span class="kbd">+</span> +5m
        <span class="kbd">v</span>/<span class="kbd">V</span> volume ‚àí/+
        <span class="kbd">1</span>/<span class="kbd">2</span>/<span class="kbd">3</span> Quick/Deep/Night
        <span class="kbd">W</span> Whole
        <span class="kbd">S</span> Sequence
        <span class="kbd">Q</span>/<span class="kbd">E</span> Prev/Next cut
      </div>
    </section>

    <!-- Builder data (official IDs) -->
    <script type="application/json" id="flow-builder-data">
    {
      "defaultPreset": "quick",
      "pick": "first",
      "entries": [
        {
          "label": "Day Flow (Mykonos 2024)",
          "youtubeId": "jTFE0dbQgdw",
          "starts": { "quick": 120, "deep": 0, "night": 1800 },
          "mode": "window",
          "segmentByPreset": {
            "quick": { "start": 120, "end": 120 + 12*60, "loop": false },
            "deep":  { "start":   0, "end":   0 + 20*60, "loop": false },
            "night": { "start": 600, "end":  600 + 12*60, "loop": true  }
          },
          "sequence": {
            "loopSequence": false,
            "cuts": [
              { "start": 120,  "end": 300,  "label":"Intro build" },
              { "start": 900,  "end": 1020, "repeats": 2, "label":"Groove pocket" },
              { "start": 1500, "end": 1620, "loop": true, "label":"Jam loop" }
            ]
          }
        },
        {
          "label": "Night Flow (Mysteryland 2025)",
          "youtubeId": "fRWVeRIcYtE",
          "starts": { "quick": 300, "deep": 0, "night": 1500 },
          "mode": "window",
          "segmentByPreset": {
            "quick": { "start": 300, "end": 300 + 12*60, "loop": false },
            "deep":  { "start": 300, "end": 300 + 20*60, "loop": false },
            "night": { "start": 1500, "end": 1500 + 12*60, "loop": true }
          },
          "sequence": {
            "loopSequence": true,
            "cuts": [
              { "start": 300,  "end": 540,  "label":"Takeoff" },
              { "start": 1200, "end": 1320, "repeats": 3, "label":"Strobe repeat" },
              { "start": 2100, "end": 2220, "label":"Deep finish" }
            ]
          }
        }
      ]
    }
    </script>

    <footer style="opacity:.8; font-size:.9rem; padding:8px"></footer>
  </div>

<script>
/* ===========================
   Utilities (no console logs)
=========================== */
(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  /* Time parse/format */
  function parseTime(v){
    if(typeof v === "number") return v;
    if(!v) return 0;
    if(/^\d+(\.\d+)?$/.test(v.trim())) return parseFloat(v);
    const parts = v.split(":").map(x=>x.trim());
    if(parts.length===2){
      const m = parseFloat(parts[0]||"0"), s = parseFloat(parts[1]||"0");
      return m*60 + s;
    } else if(parts.length===3){
      const h=parseFloat(parts[0]||"0"), m=parseFloat(parts[1]||"0"), s=parseFloat(parts[2]||"0");
      return h*3600 + m*60 + s;
    }
    return 0;
  }
  function fmtTime(secs){
    secs = Math.max(0, Math.round(secs));
    const m = Math.floor(secs/60), s = secs%60;
    return (m<10? ""+m : ""+m) + ":" + (s<10 ? "0"+s : ""+s);
  }

  /* Base64 (Unicode safe) */
  function b64Encode(obj){
    const str = (typeof obj === 'string') ? obj : JSON.stringify(obj);
    const bytes = new TextEncoder().encode(str);
    let bin = "";
    bytes.forEach(b=> bin += String.fromCharCode(b));
    return btoa(bin);
  }
  function b64DecodeToObj(b64){
    try{
      const bin = atob(b64);
      const bytes = new Uint8Array([...bin].map(ch=> ch.charCodeAt(0)));
      const txt = new TextDecoder().decode(bytes);
      return JSON.parse(txt);
    }catch(e){ return null; }
  }

  /* Local storage helpers */
  const LS = {
    get(k, d){ try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; }catch(e){ return d; } },
    set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} },
    del(k){ try{ localStorage.removeItem(k);}catch(e){} }
  };

  /* Volume ramp (soft jump) */
  function rampVolume(setVol, from, to, ms){
    return new Promise(resolve=>{
      const t0 = performance.now();
      const dur = Math.max(60, ms||120);
      function step(t){
        const k = Math.min(1, (t - t0)/dur);
        const v = from + (to - from) * k;
        setVol(v);
        if(k < 1) requestAnimationFrame(step);
        else resolve();
      }
      requestAnimationFrame(step);
    });
  }

  /* Download helper */
  function download(name, data){
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 1000);
  }

  /* Accessible notify */
  function showChip(el, msg){
    el.textContent = msg; el.style.display = "inline-flex";
    setTimeout(()=> { el.style.display="none"; }, 2400);
  }

  /* ===========================
     FlowRoom (Public API)
  =========================== */
  const FlowRoom = (function(){
    const yt = $("#yt");
    const startOverlay = $("#startOverlay");
    const startBtn = $("#startBtn");
    const playPause = $("#playPause");
    const timerText = $("#timerText");
    const extendBtn = $("#extend");
    const volSlider = $("#vol");
    const presetBtns = $$(".preset");
    const trackPicker = $("#trackPicker");
    const cutLabel = $("#cutLabel");

    /* Modes UI */
    const modeBtns = {
      whole: $("#modeWhole"),
      window: $("#modeWindow"),
      sequence: $("#modeSeq")
    };

    /* State */
    const state = {
      playerReady:false,
      listening:false,
      currentTime:0,
      duration:0,
      playing:false,
      youtubeId:"",
      trackLabel:"",
      starts:{quick:0, deep:0, night:0},
      preset: LS.get("flow.preset","quick"),
      mode: LS.get("flow.mode","whole"),
      volume: LS.get("flow.vol", 0.8),
      /* Timer */
      timerSec: (LS.get("flow.preset","quick")==="deep" ? 20*60 : 12*60),
      timerRunning:false,
      lastTick:0,

      /* Segment window */
      window:{ start:0, end:12*60, loop:false },
      segmentByPreset:null,

      /* Sequence */
      sequence:{ cuts:[], loopSequence:false },
      seqIndex:0,
      seqRepeatsLeft:0,

      softSeekInFlight:false
    };

    /* Build the YouTube src lazily on loadTrack */
    function buildSrc(id){
      const params = [
        "enablejsapi=1",
        "playsinline=1",
        "rel=0",
        "modestbranding=1",
        "iv_load_policy=3",
        "controls=0"
      ].join("&");
      return "https://www.youtube-nocookie.com/embed/" + encodeURIComponent(id) + "?" + params;
    }

    function post(cmd, args){
      if(!state.playerReady && cmd!=="addEventListener") return;
      const payload = JSON.stringify({event:"command", func:cmd, args:args || []});
      if(yt && yt.contentWindow) yt.contentWindow.postMessage(payload, "*");
    }

    function sendListening(){
      if(state.listening || !yt.contentWindow) return;
      const msg = JSON.stringify({event:"listening", id:"flow-studio"});
      yt.contentWindow.postMessage(msg, "*");
      state.listening = true;
    }

    function onMessage(e){
      const src = (typeof e.data === "string") ? e.data : "";
      if(!src) return;
      let data;
      try { data = JSON.parse(src); } catch(err){ return; }
      if(data.event === "onReady"){
        state.playerReady = true;
        /* Initialize volume and request infoDelivery updates */
        post("setVolume", [Math.round(state.volume*100)]);
        post("unMute");
      }
      if(data.event === "infoDelivery" && data.info){
        if(typeof data.info.currentTime === "number") state.currentTime = data.info.currentTime;
        if(typeof data.info.duration === "number") state.duration = data.info.duration;
        enforceWindows();
      }
      if(data.event === "onStateChange"){
        /* 1=playing, 2=paused, 0=ended (per IFrame API) */
        if(data.info === 1){ state.playing = true; startOverlay.classList.add("hidden"); playPause.textContent = "Pause"; }
        if(data.info === 2){ state.playing = false; playPause.textContent = "Start"; }
        if(data.info === 0){ state.playing = false; playPause.textContent = "Start"; /* natural end */ }
      }
    }
    window.addEventListener("message", onMessage);

    yt.addEventListener("load", function(){
      sendListening();
      /* Request periodic infoDelivery */
      post("addEventListener", ["onStateChange"]);
      post("addEventListener", ["onPlaybackQualityChange"]);
      post("addEventListener", ["onPlaybackRateChange"]);
      post("addEventListener", ["onError"]);
      post("addEventListener", ["onReady"]);
    });

    function setVolume(v){
      state.volume = Math.max(0, Math.min(1, v));
      post("setVolume", [Math.round(state.volume*100)]);
      if(state.volume > 0) post("unMute");
      LS.set("flow.vol", state.volume);
    }

    function softSeek(to){
      if(state.softSeekInFlight) return;
      state.softSeekInFlight = true;
      const prevVol = state.volume;
      const dip = Math.max(0, prevVol * 0.15);
      rampVolume(setVolume, prevVol, dip, 120).then(()=>{
        post("seekTo", [to, true]);
        return rampVolume(setVolume, dip, prevVol, 140);
      }).then(()=>{ state.softSeekInFlight=false; });
    }

    function enforceWindows(){
      if(!state.playing) return;
      if(state.mode === "window"){
        const w = state.window;
        if(state.currentTime < w.start - 0.35){ softSeek(w.start); }
        if(state.currentTime >= w.end){
          if(w.loop){ softSeek(w.start); }
          else { endFlow("window_end"); }
        }
      } else if(state.mode === "sequence"){
        const cuts = state.sequence.cuts;
        if(!cuts.length) return;
        const c = cuts[state.seqIndex] || cuts[0];
        if(typeof c === "undefined") return;
        /* Update cut label */
        showCutLabel(c.label);
        if(state.currentTime < c.start - 0.35){ softSeek(c.start); }
        if(state.currentTime >= c.end){
          if(c.loop){ softSeek(c.start); return; }
          if(state.seqRepeatsLeft > 0){ state.seqRepeatsLeft--; softSeek(c.start); return; }
          nextCut();
        }
      }
    }

    function showCutLabel(label){
      if(label){ cutLabel.style.display="inline-flex"; cutLabel.textContent = label; }
      else { cutLabel.style.display = "none"; }
    }

    function endFlow(reason){
      pause();
      document.dispatchEvent(new CustomEvent("flow:end",{detail:{reason}}));
    }

    function play(){
      post("playVideo",[]);
      state.playing = true;
      startOverlay.classList.add("hidden");
      playPause.textContent = "Pause";
    }
    function pause(){
      post("pauseVideo",[]);
      state.playing = false;
      playPause.textContent = "Start";
    }
    function toggle(){
      if(state.playing) pause();
      else play();
    }

    /* Timer loop ~1s via rAF */
    function tick(t){
      if(!state.lastTick) state.lastTick = t;
      if(t - state.lastTick >= 950){
        state.lastTick = t;
        if(state.timerRunning && state.timerSec > 0){
          state.timerSec--;
          timerText.textContent = fmtTime(state.timerSec);
          timerText.setAttribute("aria-label", "Timer " + fmtTime(state.timerSec) + " remaining");
          if(state.timerSec <= 0){
            state.timerRunning = false;
            endFlow("timer");
          }
        }
      }
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    /* Public API & Wiring */
    function applyPreset(p){
      state.preset = p;
      LS.set("flow.preset", p);
      const mins = (p==="deep") ? 20 : 12;
      state.timerSec = mins*60;
      timerText.textContent = fmtTime(state.timerSec);
      if(state.segmentByPreset && state.segmentByPreset[p]){
        const w = state.segmentByPreset[p];
        setWindow(w);
      }
      for(const k in modeBtns){ modeBtns[k].setAttribute("aria-pressed", String(state.mode===k)); modeBtns[k].setAttribute("aria-selected", String(state.mode===k)); }
    }

    function setMode(m){
      state.mode = m;
      LS.set("flow.mode", m);
      for(const k in modeBtns){
        const pressed = (k===m);
        modeBtns[k].setAttribute("aria-pressed", String(pressed));
        modeBtns[k].setAttribute("aria-selected", String(pressed));
      }
    }

    function setWindow(obj){
      state.window = {
        start: parseTime(obj.start),
        end: parseTime(obj.end),
        loop: !!obj.loop
      };
      setMode("window");
    }

    function setWindowByPreset(map){
      state.segmentByPreset = {
        quick:{start:parseTime(map.quick.start), end:parseTime(map.quick.end), loop:!!map.quick.loop},
        deep:{start:parseTime(map.deep.start), end:parseTime(map.deep.end), loop:!!map.deep.loop},
        night:{start:parseTime(map.night.start), end:parseTime(map.night.end), loop:!!map.night.loop}
      };
    }

    function setSequence(seq){
      const cuts = (seq.cuts||[]).map(c=>({
        start: parseTime(c.start),
        end: parseTime(c.end),
        loop: !!c.loop,
        repeats: Math.max(0, parseInt(c.repeats||0,10)),
        label: c.label||""
      })).filter(c=> c.end>c.start);
      state.sequence = { cuts, loopSequence: !!seq.loopSequence };
      state.seqIndex = 0;
      state.seqRepeatsLeft = (cuts[0] && cuts[0].repeats) || 0;
      setMode("sequence");
      if(cuts[0]){ softSeek(cuts[0].start); showCutLabel(cuts[0].label); }
    }

    function nextCut(){
      const cuts = state.sequence.cuts;
      if(!cuts.length){ endFlow("sequence_end"); return; }
      if(state.seqIndex < cuts.length - 1){
        state.seqIndex++;
      } else {
        if(state.sequence.loopSequence){ state.seqIndex = 0; }
        else { endFlow("sequence_end"); return; }
      }
      const c = cuts[state.seqIndex];
      state.seqRepeatsLeft = c.repeats || 0;
      showCutLabel(c.label);
      softSeek(c.start);
    }

    function prevCut(){
      const cuts = state.sequence.cuts;
      if(!cuts.length) return;
      if(state.seqIndex > 0){ state.seqIndex--; }
      else {
        if(state.sequence.loopSequence){ state.seqIndex = cuts.length - 1; }
      }
      const c = cuts[state.seqIndex];
      state.seqRepeatsLeft = c.repeats || 0;
      showCutLabel(c.label);
      softSeek(c.start);
    }

    function loadTrack({ youtubeId, starts, defaultPreset, label, segmentByPreset, sequence }){
      state.youtubeId = youtubeId;
      state.trackLabel = label || "";
      state.starts = starts || {quick:0, deep:0, night:0};
      yt.src = buildSrc(youtubeId);
      /* ensure overlay visible and timer stopped initially */
      startOverlay.classList.remove("hidden");
      state.timerRunning = false;
      /* per-preset windows/sequence */
      if(segmentByPreset) setWindowByPreset(segmentByPreset);
      if(sequence) state.sequence = { cuts: sequence.cuts || [], loopSequence: !!sequence.loopSequence };
      if(defaultPreset) applyPreset(defaultPreset);
      /* seek to preset start once ready & user starts */
    }

    function exportState(){
      const out = {
        youtubeId: state.youtubeId,
        trackLabel: state.trackLabel,
        starts: state.starts,
        preset: state.preset,
        mode: state.mode,
        window: state.window,
        sequence: state.sequence,
        segmentByPreset: state.segmentByPreset
      };
      return JSON.stringify(out);
    }

    function importState(jsonOrObj){
      let obj = jsonOrObj;
      if(typeof jsonOrObj === "string"){
        try{ obj = JSON.parse(jsonOrObj); }catch(e){ return; }
      }
      if(!obj || !obj.youtubeId) return;
      loadTrack({
        youtubeId: obj.youtubeId,
        starts: obj.starts,
        defaultPreset: obj.preset || "quick",
        label: obj.trackLabel || "",
        segmentByPreset: obj.segmentByPreset || null,
        sequence: obj.sequence || null
      });
      setMode(obj.mode || "whole");
      if(obj.mode === "window" && obj.window) setWindow(obj.window);
      if(obj.mode === "sequence" && obj.sequence) setSequence(obj.sequence);
    }

    function getTime(){ return state.currentTime || 0; }

    function setWindowFromNow(seconds){
      const now = getTime();
      setWindow({start: now, end: now + (seconds||0), loop:false});
    }

    /* Wiring controls */
    startBtn.addEventListener("click", function(){
      /* On first user gesture, seek to preset start (if defined) then play */
      const presetStart = state.starts?.[state.preset] || 0;
      if(presetStart > 0) post("seekTo",[presetStart, true]);
      play();
      state.timerRunning = true;
    });
    playPause.addEventListener("click", function(){
      if(state.playing){ pause(); state.timerRunning = false; }
      else { play(); state.timerRunning = true; }
    });
    extendBtn.addEventListener("click", function(){ state.timerSec += 5*60; timerText.textContent = fmtTime(state.timerSec); });

    volSlider.value = String(state.volume);
    volSlider.addEventListener("input", function(){ setVolume(parseFloat(this.value||"0")); });

    presetBtns.forEach(btn=>{
      btn.addEventListener("click", function(){
        const p = this.getAttribute("data-preset");
        applyPreset(p);
      });
    });

    modeBtns.whole.addEventListener("click", ()=> setMode("whole"));
    modeBtns.window.addEventListener("click", ()=> setMode("window"));
    modeBtns.sequence.addEventListener("click", ()=> setMode("sequence"));
    $("#prevCut").addEventListener("click", prevCut);
    $("#nextCut").addEventListener("click", nextCut);

    /* Track picker */
    trackPicker.addEventListener("change", function(){
      const idx = parseInt(this.value,10);
      const entry = FlowData.entries[idx];
      if(entry){
        loadTrack({
          youtubeId: entry.youtubeId,
          starts: entry.starts,
          defaultPreset: FlowData.defaultPreset || "quick",
          label: entry.label,
          segmentByPreset: entry.segmentByPreset,
          sequence: entry.sequence
        });
      }
    });

    /* Public */
    return {
      /* Controls */
      play, pause, toggle,
      /* API */
      loadTrack,
      setPlayMode: setMode,
      setWindow,
      setWindowByPreset,
      setSequence,
      nextCut, prevCut,
      exportState,
      importState,
      getTime,
      setWindowFromNow,

      /* Internals exposed for editor */
      _state: state,
      _post: post,
      _softSeek: softSeek
    };
  })();

  window.FlowRoom = FlowRoom;

  /* ===========================
     Builder Data & Initialization
  =========================== */
  const FlowData = (function(){
    let data = null;
    if(window.FlowTracks && window.FlowTracks.entries){ data = window.FlowTracks; }
    if(!data){
      try{
        const raw = document.getElementById("flow-builder-data").textContent.trim();
        data = JSON.parse(raw);
      }catch(e){ data = { defaultPreset:"quick", pick:"first", entries:[] }; }
    }
    return data;
  })();
  window.FlowData = FlowData;

  /* Populate track picker */
  const trackPicker = document.getElementById("trackPicker");
  FlowData.entries.forEach((e,i)=>{
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = e.label || ("Track "+(i+1));
    trackPicker.appendChild(opt);
  });

  /* Default pick */
  (function initLoad(){
    const entry = FlowData.entries[0];
    if(entry){
      FlowRoom.loadTrack({
        youtubeId: entry.youtubeId,
        starts: entry.starts,
        defaultPreset: FlowData.defaultPreset || "quick",
        label: entry.label,
        segmentByPreset: entry.segmentByPreset,
        sequence: entry.sequence
      });
      trackPicker.value = "0";
    }
  })();

  /* ===========================
     Segment Editor
  =========================== */
  const segStart = $("#segStart"), segEnd = $("#segEnd"), segLoop = $("#segLoop");
  $("#applySeg").addEventListener("click", function(){
    FlowRoom.setWindow({ start: parseTime(segStart.value), end: parseTime(segEnd.value), loop: segLoop.checked });
    FlowRoom.setPlayMode("window");
  });
  $("#fromNow12").addEventListener("click", function(){ FlowRoom.setWindowFromNow(12*60); FlowRoom.setPlayMode("window"); });
  $("#fromNow20").addEventListener("click", function(){ FlowRoom.setWindowFromNow(20*60); FlowRoom.setPlayMode("window"); });

  /* Tap tempo */
  const tapBtn = $("#tapBtn"), bpmOut = $("#bpmOut"), barsSel = $("#barsSel");
  const taps = [];
  tapBtn.addEventListener("click", function(){
    const now = performance.now();
    taps.push(now);
    if(taps.length>8) taps.shift();
    if(taps.length>=3){
      const intervals = taps.slice(1).map((t,i)=> t - taps[i]);
      const avgMs = intervals.reduce((a,b)=>a+b,0)/intervals.length;
      const bpm = 60000/avgMs;
      bpmOut.textContent = Math.round(bpm);
    }
  });
  $("#snapWindow").addEventListener("click", function(){
    const bpm = parseInt(bpmOut.textContent,10);
    if(!bpm || bpm<40 || bpm>220) return;
    const bars = parseInt(barsSel.value,10)||16;
    const barLen = (60/bpm)*4; /* 4/4 bars */
    const secs = barLen * bars;
    FlowRoom.setWindowFromNow(secs);
    FlowRoom.setPlayMode("window");
  });

  /* ===========================
     Sequence Editor
  =========================== */
  const list = $("#cutsList"), loopSeq = $("#loopSeq");
  const cutsModel = [];
  function renderCuts(){
    list.innerHTML = "";
    cutsModel.forEach((c,idx)=>{
      const row = document.createElement("div");
      row.className = "row";
      row.setAttribute("role","listitem");
      row.style.justifyContent="space-between";
      const left = document.createElement("div");
      left.className = "row";
      left.style.gap="10px";
      const sw = document.createElement("div");
      sw.className = "swatch";
      sw.style.background = "color-mix(in sRGB, var(--accent) 35%, transparent)";
      left.appendChild(sw);
      const txt = document.createElement("div");
      const rep = c.loop ? "‚àû" : (c.repeats||0);
      txt.textContent = `${fmtTime(c.start)} ‚Üí ${fmtTime(c.end)}  ‚Ä¢  rep:${rep}  ${c.label? "‚Ä¢ "+c.label: ""}`;
      left.appendChild(txt);
      const right = document.createElement("div");
      right.className="actions";
      const up = document.createElement("button"); up.className="btn ghost"; up.textContent="‚Üë"; up.ariaLabel="Move up";
      const dn = document.createElement("button"); dn.className="btn ghost"; dn.textContent="‚Üì"; dn.ariaLabel="Move down";
      const del = document.createElement("button"); del.className="btn"; del.textContent="√ó"; del.ariaLabel="Delete";
      up.addEventListener("click", ()=>{ if(idx>0){ const t=cutsModel[idx-1]; cutsModel[idx-1]=cutsModel[idx]; cutsModel[idx]=t; renderCuts(); }});
      dn.addEventListener("click", ()=>{ if(idx<cutsModel.length-1){ const t=cutsModel[idx+1]; cutsModel[idx+1]=cutsModel[idx]; cutsModel[idx]=t; renderCuts(); }});
      del.addEventListener("click", ()=>{ cutsModel.splice(idx,1); renderCuts(); });
      right.append(up,dn,del);
      row.append(left,right);
      list.appendChild(row);
    });
  }
  $("#addCut").addEventListener("click", function(){
    const s = parseTime($("#cutStart").value), e = parseTime($("#cutEnd").value);
    if(!(e>s)) return;
    cutsModel.push({ start:s, end:e, repeats: Math.max(0, parseInt($("#cutRepeats").value||"0",10)), loop: $("#cutLoop").checked, label: $("#cutLabelInput").value.trim() });
    renderCuts();
  });
  $("#applySeq").addEventListener("click", function(){
    FlowRoom.setSequence({ cuts: cutsModel.slice(), loopSequence: $("#loopSeq").checked });
  });
  $("#btnPrevCut").addEventListener("click", ()=> FlowRoom.prevCut());
  $("#btnNextCut").addEventListener("click", ()=> FlowRoom.nextCut());

  /* ===========================
     Share Tools
  =========================== */
  $("#copyLink").addEventListener("click", function(){
    const s = FlowRoom.exportState();
    const b = b64Encode(s);
    const url = location.origin ? (location.origin + location.pathname + "#flow=" + b) : (location.pathname + "#flow=" + b);
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(url).then(()=> showChip($("#shareMsg"), "Link copied")).catch(()=> { showChip($("#shareMsg"), "Link ready in URL"); location.hash = "flow="+b; });
    } else { location.hash = "flow="+b; showChip($("#shareMsg"), "Link in URL"); }
  });
  $("#exportState").addEventListener("click", function(){
    const s = FlowRoom.exportState(); download("flow_state.json", s);
  });

  /* Import from URL hash */
  (function importFromHash(){
    if(location.hash && location.hash.startsWith("#flow=")){
      const b64 = location.hash.replace("#flow=","").trim();
      const obj = b64DecodeToObj(b64);
      if(obj) FlowRoom.importState(obj);
    }
  })();

  /* ===========================
     Favorites with DJ Notes
  =========================== */
  const FKEY = "motion.favorites";
  const favoritesEl = $("#favorites");
  function renderFavorites(){
    favoritesEl.innerHTML = "";
    const favs = LS.get(FKEY, []);
    favs.forEach((f,idx)=>{
      const card = document.createElement("div");
      card.className = "fav";
      const row1 = document.createElement("div"); row1.className="row"; row1.style.justifyContent="space-between";
      const title = document.createElement("div"); title.style.fontWeight="800"; title.textContent = f.title || f.trackLabel || "Untitled";
      const sw = document.createElement("div"); sw.className="swatch"; sw.style.background = "color-mix(in sRGB, var(--accent) 10%, var(--accent))";
      /* Color swatch by theme token */
      sw.style.setProperty("background", themeColorFromToken(f.colorTag||"emerald-drift"));
      sw.style.borderColor = "rgba(0,0,0,.2)";
      row1.append(title, sw);

      const meta = document.createElement("div");
      meta.style.opacity=".85";
      meta.textContent = `${f.mode.toUpperCase()} ‚Ä¢ ${f.preset || "quick"} ‚Ä¢ ${new Date(f.created_at).toLocaleString()}`;

      const notes = document.createElement("div");
      notes.style.fontSize=".92rem"; notes.style.opacity=".9"; notes.textContent = f.notes || "";

      const actions = document.createElement("div"); actions.className="actions";
      const playBtn = document.createElement("button"); playBtn.className="btn"; playBtn.textContent="Play";
      const linkBtn = document.createElement("button"); linkBtn.className="btn ghost"; linkBtn.textContent="Link";
      const delBtn = document.createElement("button"); delBtn.className="btn ghost"; delBtn.textContent="Delete";
      playBtn.addEventListener("click", ()=> FlowRoom.importState(f.state));
      linkBtn.addEventListener("click", ()=>{
        const b = b64Encode(f.state);
        const url = location.origin ? (location.origin + location.pathname + "#flow=" + b) : (location.pathname + "#flow=" + b);
        if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(url); }
      });
      delBtn.addEventListener("click", ()=>{
        const fv = LS.get(FKEY,[]);
        fv.splice(idx,1); LS.set(FKEY,fv); renderFavorites();
      });

      card.append(row1, meta, notes, actions);
      actions.append(playBtn, linkBtn, delBtn);
      favoritesEl.appendChild(card);
    });
  }
  function themeColorFromToken(token){
    const map = {
      "emerald-drift":"#0bbf8a","teal-current":"#00c2a8","jade-pulse":"#15a87a","forest-glass":"#0a6a4e",
      "verdigris-line":"#19e6cb","celadon-mist":"#a8e5d4","pine-shadow":"#093c31","mint-vapor":"#d6fff3",
      "seafoam-glow":"#6dd9c5","neon-sprout":"#32ffbe"
    };
    return map[token] || "#0bbf8a";
  }
  $("#saveFav").addEventListener("click", function(){
    const stateStr = FlowRoom.exportState();
    const fav = {
      state: stateStr,
      youtubeId: FlowRoom._state.youtubeId,
      starts: FlowRoom._state.starts,
      trackLabel: FlowRoom._state.trackLabel,
      mode: FlowRoom._state.mode,
      preset: FlowRoom._state.preset,
      colorTag: $("#favColor").value,
      title: $("#favTitle").value.trim(),
      notes: $("#favNotes").value.trim(),
      created_at: Date.now()
    };
    const lst = LS.get(FKEY,[]); lst.unshift(fav); LS.set(FKEY,lst); renderFavorites();
    $("#favTitle").value = ""; $("#favNotes").value = "";
  });
  renderFavorites();

  /* ===========================
     Display Mode + PIN Lock
  =========================== */
  const displayToggle = $("#displayToggle");
  const lockBtn = $("#lockBtn");
  const badge = $("#displayBadge");
  const PIN = "4242";
  let longPressTimer = null;

  function applyDisplayHeader(){
    const cfg = window.MotionDisplay || {};
    $("#displayName").textContent = cfg.name || "Guest";
    const a = $("#displayAvatar");
    if(cfg.avatar){ a.style.backgroundImage = "url('"+cfg.avatar+"')"; }
    if(cfg.theme_color){
      /* Snap to nearest token if possible; else set inline accent */
      document.documentElement.style.setProperty("--accent", cfg.theme_color);
    }
  }
  applyDisplayHeader();

  function setViewDisplay(flag){
    document.body.setAttribute("data-view", flag? "display": "");
    displayToggle.setAttribute("aria-pressed", String(!!flag));
    displayToggle.textContent = flag? "Editor" : "Display";
    LS.set("motion.view", flag? "display":"editor");
  }
  displayToggle.addEventListener("click", function(){
    const isDisplay = document.body.getAttribute("data-view")==="display";
    setViewDisplay(!isDisplay);
  });

  function setLocked(flag){
    document.body.setAttribute("data-locked", String(!!flag));
    LS.set("motion.locked", !!flag);
  }
  lockBtn.addEventListener("click", ()=> setLocked(true));

  badge.addEventListener("pointerdown", function(){
    longPressTimer = setTimeout(()=>{
      const pin = prompt("Enter PIN to unlock:");
      if(pin === PIN){ setLocked(false); }
    }, 600);
  });
  badge.addEventListener("pointerup", ()=> { if(longPressTimer){ clearTimeout(longPressTimer); longPressTimer=null; }});
  badge.addEventListener("pointerleave", ()=> { if(longPressTimer){ clearTimeout(longPressTimer); longPressTimer=null; }});

  /* Restore persisted view + lock + theme */
  (function restoreUI(){
    const view = LS.get("motion.view","editor");
    setViewDisplay(view==="display");
    setLocked(LS.get("motion.locked", false));
  })();

  /* ===========================
     Theme Picker
  =========================== */
  const themePicker = $("#themePicker");
  const savedTheme = LS.get("motion.theme","emerald-drift");
  document.documentElement.setAttribute("data-theme", savedTheme);
  themePicker.value = savedTheme;
  themePicker.addEventListener("change", function(){
    const v = this.value; document.documentElement.setAttribute("data-theme", v); LS.set("motion.theme", v);
  });

  /* ===========================
     Check-In
  =========================== */
  const CKEY = "motion.checkins";
  function renderCheckins(){
    const c = LS.get(CKEY,[]);
    const el = $("#ciCards"); el.innerHTML = "";
    c.forEach(item=>{
      const card = document.createElement("div"); card.className="card";
      const h = document.createElement("div"); h.style.fontWeight="800";
      h.textContent = new Date(item.ts).toLocaleString();
      const d = document.createElement("div");
      d.textContent = `Mood: ${item.mood || "‚Äî"} ‚Ä¢ Energy: ${item.energy} ‚Ä¢ Body: ${item.body}`;
      const i = document.createElement("div"); i.textContent = `Intention: ${item.intent || "‚Äî"}`;
      const n = document.createElement("div"); n.textContent = item.notes || "";
      card.append(h,d,i,n); el.appendChild(card);
    });
  }
  renderCheckins();

  $("#ciLog").addEventListener("click", function(){
    const rec = {
      ts: Date.now(),
      mood: $("#ciMood").value.trim(),
      energy: parseInt($("#ciEnergy").value,10),
      body: $("#ciBody").value,
      intent: $("#ciIntent").value.trim(),
      notes: $("#ciNotes").value.trim()
    };
    const arr = LS.get(CKEY,[]); arr.unshift(rec); LS.set(CKEY, arr); renderCheckins();
    $("#ciMood").value=""; $("#ciIntent").value=""; $("#ciNotes").value="";
  });
  $("#ciExport").addEventListener("click", function(){
    const arr = LS.get(CKEY,[]); download("motion_checkins.json", JSON.stringify(arr,null,2));
  });
  $("#ciClear").addEventListener("click", function(){ LS.set(CKEY, []); renderCheckins(); });

  /* Auto-open Check-In on end, prefill note */
  document.addEventListener("flow:end", function(ev){
    const reason = (ev && ev.detail && ev.detail.reason) || "end";
    const note = `Close: ${FlowRoom._state.mode} ‚Ä¢ ${FlowRoom._state.preset}`;
    $("#ciNotes").value = note + (reason==="timer" ? " ‚Ä¢ timer" : "");
    /* Ensure panel visible (in editor mode) */
    if(document.body.getAttribute("data-view")==="display"){ setViewDisplay(false); }
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  });

  /* ===========================
     Keyboard Shortcuts
  =========================== */
  window.addEventListener("keydown", function(e){
    const active = document.activeElement;
    const isTyping = active && (active.tagName==="INPUT" || active.tagName==="TEXTAREA" || active.tagName==="SELECT" || active.isContentEditable);
    if(isTyping) return;

    if(e.code==="Space"){ e.preventDefault(); FlowRoom.toggle(); FlowRoom._state.timerRunning = FlowRoom._state.playing; }
    if(e.key==="+"){ FlowRoom._state.timerSec += 5*60; $("#timerText").textContent = fmtTime(FlowRoom._state.timerSec); }
    if(e.key==="v"){ const v = Math.max(0, FlowRoom._state.volume - 0.05); $("#vol").value = String(v); FlowRoom._post("setVolume",[Math.round(v*100)]); FlowRoom._state.volume=v; }
    if(e.key==="V"){ const v = Math.min(1, FlowRoom._state.volume + 0.05); $("#vol").value = String(v); FlowRoom._post("setVolume",[Math.round(v*100)]); FlowRoom._state.volume=v; }
    if(e.key==="1"){ FlowRoom._state.timerSec = 12*60; FlowRoom._state.preset="quick"; FlowRoom.setPlayMode(FlowRoom._state.mode); }
    if(e.key==="2"){ FlowRoom._state.timerSec = 20*60; FlowRoom._state.preset="deep";  FlowRoom.setPlayMode(FlowRoom._state.mode); }
    if(e.key==="3"){ FlowRoom._state.timerSec = 12*60; FlowRoom._state.preset="night"; FlowRoom.setPlayMode(FlowRoom._state.mode); }
    if(e.key==="W" || e.key==="w"){ FlowRoom.setPlayMode("whole"); }
    if(e.key==="S" || e.key==="s"){ FlowRoom.setPlayMode("sequence"); }
    if(e.key==="Q" || e.key==="q"){ FlowRoom.prevCut(); }
    if(e.key==="E" || e.key==="e"){ FlowRoom.nextCut(); }
  });

  /* ===========================
     Apply initial preset + reduced motion
  =========================== */
  FlowRoom.setPlayMode(FlowRoom._state.mode);
  /* Respect initial preset choice from builder */
  FlowRoom._state.timerSec = (FlowData.defaultPreset==="deep" ? 20*60 : 12*60);
  $("#timerText").textContent = (FlowData.defaultPreset==="deep") ? "20:00" : "12:00";

  /* Reduced motion: minimize transitions if user prefers */
  try{
    if(window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches){
      document.querySelectorAll("*").forEach(el=>{ el.style.transitionDuration = "0s"; });
    }
  }catch(e){}

  /* If hash present after init, timer text reflects imported state (handled in importFromHash) */

})();
</script>
</body>
</html>
